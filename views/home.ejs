<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registration | HackOnHills</title>
    <style>
        :root {
            --primary: #2563eb;
            --dark-bg: #060010;
            --light-text: #f8fafc;
            --danger: #ef4444;
            --success: #22c55e;
        }
        
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        body { margin: 0; padding: 0; display: flex; height: 100vh; overflow: hidden; }

        /* --- LEFT SIDE: FORM (60%) --- */
        .form-section {
            flex: 6;
            padding: 40px;
            overflow-y: auto;
            background-color: #ffffff;
            position: relative;
        }

        .form-container { max-width: 600px; margin: 0 auto; }
        
        h1 { color: #333; margin-bottom: 30px; border-bottom: 2px solid var(--primary); display: inline-block; padding-bottom: 5px; }

        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #4b5563; }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            background: #f8fafc;
            transition: border 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            background: #fff;
        }

        button {
            width: 100%;
            padding: 14px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 10px;
        }
        button:hover { background-color: #1d4ed8; }
        button:disabled { background-color: #94a3b8; cursor: not-allowed; }

        /* Notification Alert Styles */
        #alert-box {
            display: none;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
            font-weight: 500;
        }
        .alert-success { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .alert-error { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

        /* --- RIGHT SIDE: SEATS INFO (40%) --- */
        .info-section {
            flex: 4;
            background-color: var(--dark-bg);
            color: var(--light-text);
            padding: 40px;
            overflow-y: auto;
            border-left: 1px solid #333;
            box-shadow: -5px 0 15px rgba(0,0,0,0.2);
        }

        .info-header { margin-bottom: 30px; text-align: center; }
        .info-header h2 { margin: 0; font-size: 24px; color: #fff; }
        .info-header p { color: #94a3b8; font-size: 14px; }

        .seat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .subject-info { display: flex; flex-direction: column; }
        .subject-code { font-weight: bold; color: var(--primary); font-size: 14px; }
        .subject-name { font-size: 13px; color: #cbd5e1; }
        .seat-count { text-align: right; font-weight: bold; font-size: 18px; }
        .seat-label { font-size: 10px; color: #64748b; display: block; }
        
        .low-seats { color: var(--danger); }
        .good-seats { color: var(--success); }

        @media (max-width: 768px) {
            body { flex-direction: column-reverse; height: auto; overflow: auto; }
            .info-section { padding: 20px; }
        }
    </style>
</head>
<body>

    <% 
        const branches = [
            'Computer Science and Engineering', 
            'Dual CSE', 
            'Electrical Engineering', 
            'Electronics and Communication Engineering', 
            'Dual ECE', 
            'Mechanical Engineering', 
            'Mathematics and Computing', 
            'Chemical Engineering', 
            'Engineering Physics', 
            'Materials Science and Engineering', 
            'Civil Engineering'
        ];

        // Mapping just for display on the Right Sidebar (User Experience)
        const subjectNames = {
            'SA-201': 'National Cadet Corps (NCC)',
            'SA-202': 'National Service Scheme (NSS)', 
            'SA-203': 'Yoga and Meditation',
            'SA-204': 'Sports Activities',
            'SA-205': 'Prayas', 
            'SA-206': 'Martial Arts',
            'SA-207': 'Music, Dance, and Dramatics',
            'SA-208': 'Social Service and Discipline',
            'SA-209': 'Photography and Creative Art',
        };
        const subjectCodes = Object.keys(subjectNames); 
    %>

    <div class="form-section">
        <div class="form-container">
            <h1>Student Registration</h1>
            
            <div id="alert-box"></div>

            <form id="regForm">
                
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" name="name" id="name" required placeholder="Enter your full name">
                </div>

                <div class="form-group">
                    <label>College Email</label>
                    <input type="email" name="email" id="email" required placeholder="rollno@college.edu">
                </div>

                <div class="form-group" style="display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <label>Gender</label>
                        <select name="gender" id="gender" required>
                            <option value="">Select</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label>Roll Number</label>
                        <input type="text" name="rollNumber" id="rollNumber" required placeholder="23MI..." style="text-transform: uppercase;">
                    </div>
                </div>

                <div class="form-group">
                    <label>Branch</label>
                    <select name="branch" id="branch" required>
                        <option value="">Select your Branch</option>
                        <% branches.forEach(branch => { %>
                            <option value="<%= branch %>"><%= branch %></option>
                        <% }) %>
                    </select>
                </div>

                <div class="form-group">
                    <label>Activity Code</label>
                    <select name="subjectCode" id="subjectCode" required>
                        <option value="">Select Code...</option>
                        <% subjectCodes.forEach((code) => { %>
                            <option value="<%= code %>"><%= code %></option>
                        <% }) %>
                    </select>
                </div>

                <button type="submit" id="submitBtn">Confirm Seat</button>
            </form>
        </div>
    </div>

    <div class="info-section">
        <div class="info-header">
            <h2>Live Availability</h2>
            <p>Real-time updates. Max 100 per subject.</p>
        </div>
        <div id="seats-container">
            <p style="text-align: center; color: #666;">Loading seat data...</p>
        </div>
    </div>

    <script>
        // --- PART 1: FORM HANDLING (AJAX) ---
        const form = document.getElementById('regForm');
        const alertBox = document.getElementById('alert-box');
        const submitBtn = document.getElementById('submitBtn');

        form.addEventListener('submit', async (e) => {
            e.preventDefault(); // Stop page reload

            // 1. Disable button to prevent double clicks
            submitBtn.disabled = true;
            submitBtn.innerText = "Processing...";
            alertBox.style.display = 'none';

            // 2. Gather Data
            const formData = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                rollNumber: document.getElementById('rollNumber').value,
                gender: document.getElementById('gender').value,
                branch: document.getElementById('branch').value,
                subjectCode: document.getElementById('subjectCode').value
            };

            try {
                // 3. Send to API
                const response = await fetch('/form', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                // 4. Handle Result (JSON Message)
                alertBox.style.display = 'block';
                alertBox.innerText = result.message; // "Seat confirmed!" or Error msg

                if (response.ok && result.success) {
                    // Success Case
                    alertBox.className = 'alert-success';
                    form.reset(); // Clear the form
                    // Force an immediate seat update on the right side
                    updateSeats(); 
                } else {
                    // Error Case
                    alertBox.className = 'alert-error';
                }

            } catch (err) {
                alertBox.style.display = 'block';
                alertBox.innerText = "Network Error. Please try again.";
                alertBox.className = 'alert-error';
            } finally {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.innerText = "Confirm Seat";
            }
        });


        // --- PART 2: LIVE SEATS POLLING ---
        const subjectNames = <%- JSON.stringify(subjectNames) %>;

        async function updateSeats() {
            try {
                const res = await fetch('/seats');
                const data = await res.json(); // Expecting array from DB/Cache
                
                const container = document.getElementById('seats-container');
                container.innerHTML = ''; 

                if (!data || data.length === 0) {
                    container.innerHTML = '<p style="text-align:center">No subject data found.</p>';
                    return;
                }

                data.forEach(sub => {
                    const available = 100 - sub.seatsFilled;
                    const name = subjectNames[sub.code] || sub.code;
                    const colorClass = available < 10 ? 'low-seats' : 'good-seats';

                    const html = `
                        <div class="seat-card">
                            <div class="subject-info">
                                <span class="subject-code">${sub.code}</span>
                                <span class="subject-name">${name}</span>
                            </div>
                            <div class="seat-count">
                                <span class="${colorClass}">${available}</span>
                                <span class="seat-label">Seats Left</span>
                            </div>
                        </div>
                    `;
                    container.innerHTML += html;

                    // Disable dropdown option if full
                    if (available <= 0) {
                        const option = document.querySelector(`#subjectCode option[value="${sub.code}"]`);
                        if(option) {
                            option.disabled = true;
                            option.innerText = sub.code + ' (FULL)';
                        }
                    }
                });

            } catch (err) {
                console.error("Failed to fetch seats", err);
            }
        }

        // Start the polling
        updateSeats();
        setInterval(updateSeats, 2000); 
    </script>
</body>
</html>